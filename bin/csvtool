#!/usr/local/bin/php

<?php

require_once __DIR__ . '/../vendor/autoload.php';

use Csvtool\ArgumentParser;
use Csvtool\Commands\CommandDispatcher;
use Csvtool\Exceptions\InvalidActionException;
use Csvtool\Exceptions\MissingArgumentException;

try {
    // Command name is the first argument given to script
    $commandName = $argv[1];
    if (!CommandDispatcher::commandExists($commandName)) {
        throw new InvalidActionException($commandName);
    }

    // Parse the given options and dispatch the command
    ArgumentParser::parse(array_slice($argv, 2), CommandDispatcher::getCommandDefinition($commandName)->args);
    CommandDispatcher::dispatch($commandName, ArgumentParser::getOptions());

} catch (InvalidActionException $e) {
    echo "Action {$e->getAction()} is not supported. See help for more details" . PHP_EOL;
    exit(1);
} catch (MissingArgumentException $e) {
    echo $e->getMessage() . " See help for more details" . PHP_EOL;
    exit(1);
} catch (Exception $e) {
    echo $e->getMessage() . PHP_EOL;
    exit(1);
}